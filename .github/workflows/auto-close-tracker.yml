name: Auto Close Tracker Issue

on:
  issues:
    types: [closed]

jobs:
  check-and-close:
    runs-on: ubuntu-latest
    permissions:
      issues: write
    steps:
      - name: Check if all sub-issues are closed
        uses: actions/github-script@v7
        with:
          script: |
            // Tracker issue number and its sub-issues
            const TRACKER_ISSUE = 10;
            const SUB_ISSUES = [5, 6, 7, 8, 9];

            const closedIssue = context.payload.issue.number;

            // Only proceed if the closed issue is one of the sub-issues
            if (!SUB_ISSUES.includes(closedIssue)) {
              console.log(`Issue #${closedIssue} is not a tracked sub-issue, skipping.`);
              return;
            }

            console.log(`Sub-issue #${closedIssue} was closed. Checking all sub-issues...`);

            // Check the state of all sub-issues
            for (const num of SUB_ISSUES) {
              const { data: issue } = await github.rest.issues.get({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: num,
              });

              if (issue.state !== 'closed') {
                console.log(`Sub-issue #${num} is still open. Not closing tracker.`);
                return;
              }
              console.log(`Sub-issue #${num} is closed.`);
            }

            // All sub-issues are closed, close the tracker
            console.log('All sub-issues closed. Closing tracker issue #' + TRACKER_ISSUE);

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: TRACKER_ISSUE,
              body: 'ğŸ‰ æ‰€æœ‰å­ä»»åŠ¡ issue (#5, #6, #7, #8, #9) å·²å…¨éƒ¨å…³é—­ï¼Œtyme4swift ä¸ tyme4j å·²å®ç° 100% åŠŸèƒ½å¯¹é½ã€‚è‡ªåŠ¨å…³é—­æœ¬è·Ÿè¸ª issueã€‚',
            });

            await github.rest.issues.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: TRACKER_ISSUE,
              state: 'closed',
              state_reason: 'completed',
            });

            console.log('Tracker issue #' + TRACKER_ISSUE + ' has been closed.');
