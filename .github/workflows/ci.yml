name: CI

on:
  push:
    branches:
      - main
  pull_request:

jobs:
  build-and-test:
    name: Build and Test
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Swift
        uses: swift-actions/setup-swift@v2
        with:
          swift-version: '6.2'

      - name: Build
        run: swift build

      - name: Run tests with coverage
        run: swift test --enable-code-coverage

      - name: Generate coverage report
        run: |
          CODECOV_JSON=$(swift test --show-codecov-path)
          if [ -f "$CODECOV_JSON" ]; then
            echo "ğŸ“Š Code coverage report: $CODECOV_JSON"
            # æå–è¦†ç›–ç‡ç™¾åˆ†æ¯”
            COVERAGE=$(cat "$CODECOV_JSON" | python3 -c "
import json, sys
data = json.load(sys.stdin)
pct = data['data'][0]['totals']['lines']['percent']
print(f'{pct:.1f}%')
")
            echo "ğŸ“ˆ Line coverage: $COVERAGE"
          else
            echo "âš ï¸  Coverage report not found"
          fi
